# PenTestScript
用于记录工作中使用的一些脚本

## Securitytrails
在渗透测试时信息收集中的[Securitytrails](https://securitytrails.com/)反查脚本。打开浏览器控制台输入需要的函数即可。

### 获取当前页面域名
```
let str = "";
const tbody = document.querySelector('tbody');
const rows = Array.from(tbody.getElementsByTagName('tr'));
rows.forEach(row => {
    const link = row.querySelector('td:first-child a').innerText;
    str += `${link}\n`;
});
console.log(str);
str = "";

```

### 获取域名下的全部子域
```
const Get_Token = () => {
  const hiddenDivs = document.getElementsByClassName('hidden');
  const buildId = Array.from(hiddenDivs).find(hiddenDiv => hiddenDiv.innerHTML.includes('Build ID'))?.innerHTML.split('>')[1] || "";
  return buildId;
};


const Get_Subdomain = (Domain, Page = 1) => {
  const Token = Get_Token();
  const url = `/_next/data/${Token}/list/apex_domain/${Domain}.json?page=${Page}&domain=${Domain}`;
  fetch(url)
    .then(response => response.json())
    .then(data => {
      const { pageProps: { apexDomainData: { data: { records } } } } = data;
      records.forEach(({ hostname }) => {
        str += `${hostname}\r\n`;
      });
      console.log(`Print Domain: ${Domain} Page: ${Page}`);
      records.length === 100 ? Get_Subdomain(Domain, Page + 1) : (console.log(str), str = "");
    })
    .catch(error => {
      console.error(`Error: ${error}`);
    });
};
let str = "";

Get_Subdomain("douyin.com");

```

### 获取IP下的全部域名
```
const Get_IP_Affiliation_Domain = (IP, Page = 1) => {
    const Token = Get_Token();
    fetch(`/_next/data/${Token}/list/ip/${IP}.json?page=${Page}&${IP}`)
        .then(response => response.json())
        .then(({ pageProps: { serverResponse: { data: { records } } } }) => {
            records.forEach(({ hostname }) => {
                str = `${str}${hostname}\r\n`;
            });
            console.log(`Print IP: ${IP} Page: ${String(Page)}`);
            records.length === 100 ? Get_IP_Affiliation_Domain(IP, Page + 1) : console.log(str);
        });
};

const Get_Token = () => {
  const hiddenDivs = document.getElementsByClassName('hidden');
  const buildId = Array.from(hiddenDivs).find(hiddenDiv => hiddenDiv.innerHTML.includes('Build ID'))?.innerHTML.split('>')[1] || "";
  return buildId;
};


let str = "";
Get_IP_Affiliation_Domain("23.224.148.203");

```

### 获取IP下的全部域名和其子域
```
const fetchSubdomainList = async (Domain, Page = 1) => {
    const Token = Get_Token();
    const response = await fetch(`/_next/data/${Token}/list/apex_domain/${Domain}.json?page=${Page}&domain=${Domain}`);
    const { pageProps: { apexDomainData: { data: { records } } } } = await response.json();
    records.forEach(({ hostname }) => {
        Subdomain_list_str = `${Subdomain_list_str}${hostname}\r\n`;
    });
    console.log(`Print Subdomain: ${Domain} Page: ${String(Page)}`);
    if (records.length === 100) {
        await fetchSubdomainList(Domain, Page + 1);
    }
};

const Get_IP_Affiliation_Domain = async (IP, Page = 1) => {
    const Token = Get_Token();
    const response = await fetch(`/_next/data/${Token}/list/ip/${IP}.json?page=${Page}&ip=${IP}`);
    const { pageProps: { serverResponse: { data: { records } } } } = await response.json();
    records.forEach(({ hostname }) => {
        Primary_list_str = `${Primary_list_str}${hostname}\r\n`;
    });
    console.log(`Print Domain: ${IP} Page: ${String(Page)}`);
    if (records.length === 100) {
        await Get_IP_Affiliation_Domain(IP, Page + 1);
    } else {
        console.log(Primary_list_str);
        const primaryListArray = Primary_list_str.split("\r\n").filter(hostname => hostname !== '');
        for (const hostname of primaryListArray) {
            await fetchSubdomainList(hostname, 1);
        }
    }
};

const Get_Token = () => {
    const hiddenDivs = document.getElementsByClassName('hidden');
    const buildId = Array.from(hiddenDivs).find(hiddenDiv => hiddenDiv.innerHTML.includes('Build ID'))?.innerHTML.split('>')[1] || "";
    return buildId;
};

const Get_IP_Affiliation_SubdomainAll = async (IP) => {
    await Get_IP_Affiliation_Domain(IP);
    console.log(Subdomain_list_str);
};


var Subdomain_list_str = "";
var Primary_list_str = "";

Get_IP_Affiliation_SubdomainAll("77.77.77.77");

```

### 获取IP段内的所有域名
```
const split_add = (ipAddress) => {
    const [ip, mask = "24"] = ipAddress.split("/");
    return { ip, mask };
};

const sendPostRequest = async (ip, mask) => {
    const url = `/api/public/app/api/vercel/ip/${ip}?mask=${mask}`;
    const postData = `mask=${mask}`;
    const response = await fetch(url, {
        method: "POST",
        body: postData,
        async: false,
        dataType: "text"
    });
    const myText = await response.text();
    const jsont = JSON.parse(myText);
    return jsont;
};


const Get_IP_To_Domain = async (Domain, Page = 1) => {
    const response = await fetch(`/_next/data/${Token}/list/ip/${Domain}.json?page=${Page}&${Domain}`, {
        method: "GET",
        async: false,
        dataType: "text"
    });
    const myText = await response.text();
    const jsont = JSON.parse(myText);
    const { pageProps: { serverResponse: { data: { records } } } } = jsont;
    records.forEach(({ hostname }) => {
        str += `${hostname}\r\n`;
    });
    console.log(`Print Domain: ${Domain} Page: ${String(Page)}`);
    records.length === 100 ? await Get_IP_To_Domain(Domain, Page + 1) : null;

};


const Get_Token = () => {
    const hiddenDivs = document.getElementsByClassName('hidden');
    const buildId = Array.from(hiddenDivs).find(hiddenDiv => hiddenDiv.innerHTML.includes('Build ID'))?.innerHTML.split('>')[1] || "";
    return buildId;
};


const getSites = async (ipAddress, site) => {
    const { ip, mask: originalMask } = split_add(ipAddress);

    if (originalMask !== "32") {
        const jsonResponse = await sendPostRequest(ip, originalMask);

        const rows = jsonResponse.result.rows;
        for (const row of rows) {
            const { sites, ip: newIpAddress } = row;
            const { mask } = split_add(ip);
            (sites !== 0 && mask !== "32") ? await getSites(newIpAddress, sites) : null;
        }

    }

    if (originalMask === "32" && site !== 0) {
        console.log(`ipAddress: ${ip} site: ${site}`);
        await Get_IP_To_Domain(ip);
    }
};


let str = "";
const Token = Get_Token();
const Run = async (ipAddress) => {
    str = "";
    await getSites(ipAddress);
    console.log(str);
};

Run("77.77.77.77/32");

```
